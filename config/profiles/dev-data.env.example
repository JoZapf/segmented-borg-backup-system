#!/usr/bin/env bash
# dev-data.env.example
# @version 1.0.2
# @description Example backup profile for Docker development data with Nextcloud DB dumps
# @author Jo Zapf
# @changed 2026-01-14
# @note Copy to dev-data.env and adjust values for your system

# ============================================================================
# PROFILE IDENTIFICATION
# ============================================================================
export BACKUP_PROFILE="dev-data"
export BACKUP_PROFILE_DESCRIPTION="Docker development data backup with Nextcloud DB dumps"

# ============================================================================
# PROFILE-SPECIFIC SEGMENTS
# ============================================================================
# Pre-backup segments (executed before main backup)
export PRE_BACKUP_SEGMENTS=(
  "pre_01_nextcloud_db_dump.sh"
  "pre_02_docker_stop.sh"
)

# Post-cleanup segments (executed after cleanup)
export POST_CLEANUP_SEGMENTS=(
  "post_01_docker_start.sh"
)

# ============================================================================
# SOURCE PATHS (What to backup)
# ============================================================================
# REPLACE with your Docker data directory
export BACKUP_SOURCES="/mnt/docker-data"

# Backup options
export BACKUP_ONE_FILE_SYSTEM="true"            # Stay within filesystem boundaries
export BACKUP_EXCLUDE_CACHES="true"             # Exclude cache directories

# ============================================================================
# DESTINATION (Where to backup)
# ============================================================================
# Mount point for backup HDD
# REPLACE with your actual mount point
export BACKUP_MNT="/mnt/extern_backup"

# REPLACE with your backup HDD UUID (find with: sudo blkid)
export BACKUP_UUID="REPLACE-WITH-YOUR-BACKUP-HDD-UUID"
export BACKUP_DEV="/dev/disk/by-uuid/${BACKUP_UUID}"

# REPLACE 'hostname' with your actual hostname
export TARGET_DIR="${BACKUP_MNT}/hostname_docker-data"
export REPO="${TARGET_DIR}/borgrepo"

# Semicolon-separated list of paths to exclude
# ADJUST based on your directory structure
export BACKUP_EXCLUDES="/mnt/docker-data/tmp;/mnt/docker-data/cache;${BACKUP_MNT}"

# ============================================================================
# HARDWARE CONTROL (Profile-specific overrides)
# ============================================================================
export SHELLY_ENABLED="false"                   # No Shelly Plug for internal HDD
export HDD_SPINDOWN_ENABLED="true"              # Spindown when not in use

# REPLACE with your backup HDD device (find with: lsblk)
export HDD_DEVICE="/dev/sdX"                    # Device for hdparm spindown

# ============================================================================
# DOCKER CONTROL
# ============================================================================
export DOCKER_ENABLED="true"                    # Enable Docker container management
export DOCKER_STOP_TIMEOUT="30"                 # Graceful shutdown timeout (seconds)

# State directory for storing running container IDs
export STATE_DIR="/tmp/backup-system-state"

# ============================================================================
# NEXTCLOUD DOCKER CONFIGURATION
# ============================================================================
export NEXTCLOUD_ENABLED="true"                 # Enable Nextcloud DB dumps

# Docker container names (REPLACE with your actual container names)
export NEXTCLOUD_DOCKER_APP_CONTAINER="nextcloud-app"
export NEXTCLOUD_DOCKER_DB_CONTAINER="nextcloud-db"

# Database type: mysql, mariadb, postgresql, postgres
export NEXTCLOUD_DB_TYPE="mariadb"

# Database credentials (from container environment)
# REPLACE with your actual Nextcloud database credentials
export NEXTCLOUD_DB_NAME="nextcloud"
export NEXTCLOUD_DB_USER="ncadmin"
export NEXTCLOUD_DB_PASSWORD="REPLACE-WITH-YOUR-DB-PASSWORD"

# ============================================================================
# RETENTION POLICY (Borg Archive Thinning Strategy)
# ============================================================================
# NOTE: All Borg archives are complete, full backups with deduplication.
# These settings control which archives to KEEP during pruning.
# Borg selects archives based on age, then applies thinning rules.

# Keep the newest archive for each of the last 14 days
export KEEP_DAILY="14"

# After daily retention: keep the newest archive per week for 8 weeks
export KEEP_WEEKLY="8"

# After weekly retention: keep the newest archive per month for 12 months
export KEEP_MONTHLY="12"

# Example timeline after 6 months of daily backups:
# - Last 14 days: 14 archives (one per day)
# - Weeks 3-8: 6 archives (one per week)
# - Months 3-6: 4 archives (one per month)
# Total: ~24 archives retained

# ============================================================================
# ARCHIVE NAMING
# ============================================================================
# REPLACE 'hostname' with your actual hostname
export ARCHIVE_PREFIX="hostname-docker-data"
