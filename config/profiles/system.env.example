#!/usr/bin/env bash
# system.env.example
# @version 2.2.0
# @description Example backup profile for system partitions (root and EFI)
# @author Jo Zapf
# @changed 2026-01-17 - Moved recovery key export to POST_BACKUP phase (was POST_CLEANUP)
# @note Copy to system.env and adjust values for your system

# ============================================================================
# PROFILE IDENTIFICATION
# ============================================================================
export BACKUP_PROFILE="system"
export BACKUP_PROFILE_DESCRIPTION="System backup: / and /boot/efi"

# ============================================================================
# SOURCE PATHS (What to backup)
# ============================================================================
# Semicolon-separated list of paths to backup
export BACKUP_SOURCES="/;/boot/efi"

# Backup options
export BACKUP_ONE_FILE_SYSTEM="true"            # Stay within filesystem boundaries
export BACKUP_EXCLUDE_CACHES="true"             # Exclude cache directories

# Semicolon-separated list of paths to exclude
export BACKUP_EXCLUDES="/proc;/sys;/dev;/run;/tmp;/var/tmp;${BACKUP_MNT}"

# ============================================================================
# DESTINATION (Where to backup)
# ============================================================================
# REPLACE WITH YOUR BACKUP HDD UUID (find with: sudo blkid)
export BACKUP_UUID="REPLACE-WITH-YOUR-BACKUP-HDD-UUID"
export BACKUP_DEV="/dev/disk/by-uuid/${BACKUP_UUID}"

# REPLACE 'hostname' with your actual hostname
export TARGET_DIR="${BACKUP_MNT}/hostname_nvme0n1_System"
export REPO="${TARGET_DIR}/borgrepo"

# ============================================================================
# HARDWARE CONTROL (Profile-specific overrides)
# ============================================================================
export SHELLY_ENABLED="true"                    # Power control via Shelly
export HDD_SPINDOWN_ENABLED="true"              # Spin down HDD before power-off

# REPLACE with your backup HDD device (find with: lsblk)
export HDD_DEVICE="/dev/sdX"                    # Device for hdparm spindown

# ============================================================================
# ARCHIVE RETENTION RULES
# ============================================================================
# How Borg stores backups:
# - REPOSITORY: The deduplicated data pool containing all backup data
# - ARCHIVES: Named snapshots/views into this data pool
# 
# All archives are complete, independent backups that share deduplicated data.
# Deleting an archive only removes its metadata and unique chunks (if any).
# The repository remains intact with all shared data preserved.
#
# These rules control which ARCHIVE SNAPSHOTS to keep when pruning:
# - KEEP_DAILY: Keep last N daily snapshots (1 per day for N days)
# - KEEP_WEEKLY: Keep last N weekly snapshots (1 per week for N weeks)  
# - KEEP_MONTHLY: Keep last N monthly snapshots (1 per month for N months)
#
# Example timeline with KEEP_DAILY=7, KEEP_WEEKLY=4, KEEP_MONTHLY=6:
#   Days 1-7:   7 snapshots (one per day)
#   Weeks 2-4:  3 snapshots (one per week)
#   Months 2-6: 5 snapshots (one per month)
#   Total: ~15 archive snapshots retained
#
# Note: All snapshots access the same deduplicated repository data.
#       Deleting old snapshots does NOT delete shared data still used by other snapshots.

export KEEP_DAILY="7"      # Keep daily snapshots for 7 days
export KEEP_WEEKLY="4"     # Keep weekly snapshots for 4 weeks
export KEEP_MONTHLY="6"    # Keep monthly snapshots for 6 months

# ============================================================================
# PROFILE-SPECIFIC SEGMENTS
# ============================================================================
# Pre-backup segments (executed before main backup)
export PRE_BACKUP_SEGMENTS=()

# Post-backup segments (executed after backup but BEFORE verify)
# CRITICAL: Recovery key export runs here while HDD is still mounted!
export POST_BACKUP_SEGMENTS=(
  "post_01_export_recovery_keys.sh"  # Export recovery keys (see common.env RECOVERY_*)
)

# Post-cleanup segments (executed after all operations complete)
# Use this for final notifications, logging, etc.
export POST_CLEANUP_SEGMENTS=()

# ============================================================================
# ARCHIVE NAMING
# ============================================================================
# REPLACE 'hostname' with your actual hostname
export ARCHIVE_PREFIX="hostname-nvme0n1-system"
